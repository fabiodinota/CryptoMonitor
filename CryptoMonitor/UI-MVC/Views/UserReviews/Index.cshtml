@{
    ViewData["Title"] = "User Reviews";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="display-4">User Reviews</h1>
        <p class="text-muted">Recent additions to tracked exchanges.</p>
    </div>
    <button id="btnRefresh" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-lg"></i> Refresh Reviews
        </button>
</div>

<div id="loading" class="text-center" style="display:none;">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div id="error-alert" class="alert alert-danger" style="display:none;">
    Failed to load reviews. Please try again later.
</div>

<table class="table table-striped table-hover" id="reviewsTable">
    <thead class="table-dark">
        <tr>
            <th>User</th>
            <th>Exchange</th>
            <th>Rating</th>
            <th>Comment</th>
            <th>Date Posted</th>
        </tr>
    </thead>
    <tbody>
        <!-- Data will be inserted here by JavaScript -->
    </tbody>
</table>

@section Scripts {
    <script>
        const apiUrl = '/api/UserReviewsRest';
        const tableBody = document.querySelector('#reviewsTable tbody');
        const btnRefresh = document.getElementById('btnRefresh');
        const loadingSpinner = document.getElementById('loading');
        const errorAlert = document.getElementById('error-alert');

        function fetchReviews() {
            loadingSpinner.style.display = 'block';
            errorAlert.style.display = 'none';
            tableBody.innerHTML = ''; 

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    if (response.status === 204) {
                        return [];
                    }
                    return response.json();
                })
                .then(data => {
                    displayReviews(data);
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    errorAlert.style.display = 'block';
                })
                .finally(() => {
                    loadingSpinner.style.display = 'none';
                });
        }

        function displayReviews(reviews) {
            tableBody.innerHTML = '';
            
            if (reviews.length === 0) {
                 const row = document.createElement('tr');
                 row.innerHTML = '<td colspan="5" class="text-center">No reviews found.</td>';
                 tableBody.appendChild(row);
                 return;
            }

            reviews.forEach(review => {
                const row = document.createElement('tr');
                
                const date = new Date(review.datePosted).toLocaleDateString() + ' ' + new Date(review.datePosted).toLocaleTimeString();

                row.innerHTML = `
                    <td>${escapeHtml(review.userName)}</td>
                    <td>${escapeHtml(review.exchangeName)}</td>
                    <td>${review.rating}/5</td>
                    <td>${escapeHtml(review.comment)}</td>
                    <td>${date}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        btnRefresh.addEventListener('click', fetchReviews);

        document.addEventListener('DOMContentLoaded', fetchReviews);
    </script>
}
