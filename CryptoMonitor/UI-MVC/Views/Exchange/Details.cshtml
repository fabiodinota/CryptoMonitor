@using CryptoMonitor.Domain
@model Exchange

@{
    ViewData["Title"] = $"{Model.Name} - Details";
}

<div class="text-center">
    <h1 class="display-3">@Model.Name - Details</h1>
    <p>Exchange information and user reviews.</p>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            Basis Informatie
        </div>
        <div class="card-body-detail"> <dl style="display: flex; text-align: left; padding: 1rem;">
                <div style="width: 100%">
                    <dt>Name</dt>
                    <dd>@Model.Name</dd>
                </div>
                <div style="width: 100%">
                    <dt>Website</dt>
                    <dd>
                        @if (!string.IsNullOrEmpty(Model.Website))
                        {
                            <a href="https://@Model.Website" target="_blank">@Model.Website</a>
                        }
                        else
                        {
                            <span class="text-muted">Unknown</span>
                        }
                    </dd>
                </div>
                <div style="width: 100%">
                    <dt>Trust Score</dt>
                    <dd>
                        @if (Model.TrustScore >= 8)
                        {
                            <span class="badge bg-success">@Model.TrustScore / 10</span>
                        }
                        else if (Model.TrustScore >= 5)
                        {
                            <span class="badge bg-warning text-dark">@Model.TrustScore / 10</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">@Model.TrustScore / 10</span>
                        }
                    </dd>
                </div>
            </dl>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    Listed Cryptocurrencies
                </div>
                <div class="card-body">
                    <table class="table table-sm table-hover" id="listingsTable">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Name</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loaded via JS -->
                        </tbody>
                    </table>
                    
                    <hr />
                    <h5>Add Listing</h5>
                    <div class="mb-3">
                        <label for="cryptoSelect" class="form-label">Cryptocurrency</label>
                        <select id="cryptoSelect" class="form-select">
                            <option value="" disabled selected>Select a crypto...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="listingDate" class="form-label">Listing Date</label>
                        <input type="datetime-local" id="listingDate" class="form-control" />
                    </div>
                    <button id="btnAddListing" class="btn btn-primary btn-sm">Add to Exchange</button>
                    <div id="addError" class="text-danger mt-2" style="display:none;"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    User Reviews
                </div>
                <div class="card-body">
                    @if (Model.Reviews != null && Model.Reviews.Any())
                    {
                        <div class="list-group list-group-flush text-left">
                            @foreach (var review in Model.Reviews)
                            {
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">@review.UserName</h5>
                                        <small>@review.DatePosted.ToString("dd/MM/yyyy")</small>
                                    </div>
                                    <p class="mb-1">"@review.Comment"</p>
                                    <small>
                                        Rating: 
                                        @for(int i=0; i < review.Rating; i++) { <span>‚≠ê</span> }
                                        (@review.Rating/5)
                                    </small>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No reviews found for this exchange.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a asp-controller="Exchange" asp-action="Index" class="btn btn-secondary">Go back to exchanges</a>
    </div>
</div>

@section Scripts {
    <script>
        const exchangeId = @Model.Id;
        const listingsTableBody = document.querySelector('#listingsTable tbody');
        const cryptoSelect = document.getElementById('cryptoSelect');
        const btnAddListing = document.getElementById('btnAddListing');
        const listingDateInput = document.getElementById('listingDate');
        const addError = document.getElementById('addError');

        // Set default date to now
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        listingDateInput.value = now.toISOString().slice(0, 16);

        function fetchListings() {
            fetch(`/api/ExchangeListingsRest/by-exchange/${exchangeId}`)
                .then(res => res.json())
                .then(data => {
                    listingsTableBody.innerHTML = '';
                    if (data.length === 0) {
                        listingsTableBody.innerHTML = '<tr><td colspan="3" class="text-muted">No listings found.</td></tr>';
                        return;
                    }
                    
                    data.forEach(item => {
                        const date = new Date(item.listingDate).toLocaleString();
                        const row = `
                            <tr>
                                <td class="font-weight-bold">
                                    <a href="/Crypto/Details/${item.cryptocurrencyId}">${item.cryptocurrencySymbol}</a>
                                </td>
                                <td>${item.cryptocurrencyName}</td>
                                <td>${date}</td>
                            </tr>
                        `;
                        listingsTableBody.insertAdjacentHTML('beforeend', row);
                    });
                })
                .catch(err => console.error("Error fetching listings", err));
        }

        function fetchAvailableCryptos() {
            fetch(`/api/ExchangeListingsRest/available-cryptos/${exchangeId}`)
                .then(res => res.json())
                .then(data => {
                    cryptoSelect.innerHTML = '<option value="" disabled selected>Select a crypto...</option>';
                    
                    data.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.text = `${c.name} (${c.symbol})`;
                        cryptoSelect.appendChild(option);
                    });
                })
                .catch(err => console.error("Error fetching available cryptos", err));
        }

        function addListing() {
            const cryptoId = cryptoSelect.value;
            const date = listingDateInput.value;

            if (!cryptoId) {
                alert("Please select a cryptocurrency.");
                return;
            }

            const payload = {
                exchangeId: exchangeId,
                cryptoId: parseInt(cryptoId),
                listingDate: date
            };

            btnAddListing.disabled = true;
            addError.style.display = 'none';

            fetch('/api/ExchangeListingsRest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (res.ok) {
                    // Success
                    fetchListings();
                    fetchAvailableCryptos(); // Refresh dropdown
                } else {
                    return res.text().then(text => { throw new Error(text || res.statusText) });
                }
            })
            .catch(err => {
                addError.textContent = "Failed to add listing: " + err.message;
                addError.style.display = 'block';
            })
            .finally(() => {
                btnAddListing.disabled = false;
            });
        }

        btnAddListing.addEventListener('click', addListing);
        
        document.addEventListener('DOMContentLoaded', () => {
            fetchListings();
            fetchAvailableCryptos();
        });
    </script>
}
